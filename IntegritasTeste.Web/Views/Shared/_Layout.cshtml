<!doctype html>
<html ng-app="app">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="content-language" content="pt-br" />
    <title>Integritas Test Joao</title>
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
</head>

<body>
    <ul class="nav nav-tabs">
        @*<li ng-class="{active: activetab == '/'}"><a href="/#/Home">Home</a></li>
            <li ng-class="{active: activetab == '/Store'}"><a href="/#/Store">Store</a></li>*@
        <li ng-class="{active: activetab == '/Products'}"><a href="/Products">Products</a></li>
        <li ng-class="{active: activetab == '/ShoppingCart'}"><a href="/ShoppingCart">ShoppingCart</a></li>
    </ul>

<div ng-view>
    @RenderBody()
</div>
    <script src="~/Content/Scripts/jquery-1.10.2.min.js"></script>
    <script src="~/Content/Scripts/bootstrap.min.js"></script>
    <script src="~/Content/Scripts/angular.min.js"></script>
    <script src="~/Content/Scripts/angular-route.min.js"></script>
    
    

<script type="text/javascript">
    var app = angular.module('app', ['ngRoute']);

    app.config(function($routeProvider, $locationProvider) {
        // remove o # da url
        $locationProvider.html5Mode(true);

        $routeProvider
            //.when('/', {
            //    templateUrl: '/Home',
            //    controller: 'HomeController',
            // })
            //.when('/Store', {
            //    templateUrl: '/Store',
            //    controller: 'StoreController',
            //})
            .when('/Products', {
                templateUrl: '/Store/Products',
                controller: 'ProductsController',
            })
            .when('/ShoppingCart', {
                templateUrl: '/Store/ShoppingCart',
                controller: 'ShoppingCartController',
            })

            // caso não seja nenhum desses, redirecione para a rota '/'
            .otherwise({ redirectTo: '/Products' });
    });


    app.controller('HomeController', function($rootScope, $location, $http) {
        $rootScope.activetab = $location.path();
    });

    app.controller('StoreController', function($rootScope, $location, $http) {
        $rootScope.activetab = $location.path();
    });
    app.controller('ShoppingCartController', function($rootScope, $location, $http) {
        $rootScope.activetab = $location.path();

        $rootScope.GetCurrentPrice = function(Prices) {

            for (var i = 0; i < Prices.length; i++) {
                return Prices[i].Value;
            }
            return 0;

        };

        $rootScope.TotalCart = function() {
            var total = 0;

            products = $rootScope.cart.products;
            for (var i = 0; i < products.length; i++) {
                total += $rootScope.GetCurrentPrice(products[i].Prices) * products[i].Quantity;
            }
            return total;
        }
        var updateCart = function(){
            $http.get('/Cart/Get').then(function(cart) {
                $rootScope.cart = cart.data;
            }, function(error) {
            
            });
        }
        updateCart();


        $rootScope.RemoveCart = function (productId) {
            //alert(productId);

            var product = $rootScope.produtos[productId];

            $http.post("/Cart/Remove", product).then(function (response) {

                if (response.data.success) {

                    $('#AddProductToCart div.modal-body p').html("Product " + product.Name + " was removed from your cart!");
                    $('#AddProductToCart').modal('show');
                    updateCart();

                } else {
                    alert('Erro no sitema');
                }
            },
                function () {
                    alert('Erro no sitema');
                });
        };

        $rootScope.UpdateCart = function () {

            var products = [];



            for (var i = 0; i < $('div.product').length; i++) {
                products.push({
                    ProductID: $($('div.product')[i]).attr('productid'),
                    Quantity: $($('div.product')[i]).find('input').val()
                });
            }
            

            $http.post("/Cart/Update", products).then(function (response) {
                if (response.data.success) {
                    $('#AddProductToCart div.modal-body p').html("Your shopping cart was updated!");                    
                    $('#AddProductToCart').modal('show');
                    updateCart();

                } else {
                    alert('Erro no sitema');
                }
            },
                function () {
                    alert('Erro no sitema');
                });
        };




    });
    app.controller('ProductsController', function($rootScope, $location, $http) {
        $rootScope.activetab = $location.path();       

        $rootScope.AddCart = function(productId) {
            

            var product = $rootScope.produtos[productId];

            $http.post("/Cart/Add", product).then(function(response) {

                    if (response.data.success) {

                        $('#AddProductToCart div.modal-body p').html("Product " + product.Name + " was removed from your cart!");
                        $('#AddProductToCart').modal('show');

                    } else {
                        alert('Erro no sitema');
                    }
                },
                function() {
                    alert('Erro no sitema');
                });
        };

        $rootScope.change = function() {

        };

        $http.get('/Api/Product').then(function(produtos) {
            $rootScope.produtos = produtos.data;
        }, function(error) {            
        });


        $http.get('/Api/Category').then(function(categories) {
            $rootScope.categories = categories.data;
        }, function(error) {
        
        });


        

    });


</script>


    <div class="modal fade" id="AddProductToCart" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Message</h4>
                </div>
                <div class="modal-body">
                    <p></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Modal title</h4>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
    </div>

</body>
</html>



@*@Scripts.Render("~/bundles/baseScripts")


    @Scripts.Render("~/bundles/jquery")
    @Scripts.Render("~/bundles/bootstrap")

    @RenderSection("scripts", required: false)*@

